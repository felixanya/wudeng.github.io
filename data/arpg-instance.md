# ARPG游戏服务器之副本设计

本文主要讨论一些服务器副本设计方面总结的一些经验。

ARPG游戏中，战斗、AOI等逻辑都是通过场景进程来实现的，
因此实现副本一般都需要启动一个场景进程来处理这些通用的消息。
而不同的玩法有不同的数据、逻辑和流程，这部分功能可以通过一个副本管理进程来实现，
这种方式我称之为双进程结构。也可以通过回调函数的方式直接在场景进程中实现，这种方式我称之为单进程结构。
下面分别进行阐述。

## 双进程结构

这种结构下，场景进程不保存玩法数据，玩法数据由专门的玩法进程来实现。
场景进程通过通过回调函数与管理进程交互。两个进程分工合作，场景进程会通过回调函数的方式向管理进程发送消息，
管理进程也会向场景进程发消息来实现特定的逻辑，如踢人、广播消息等。场景进程由副本管理进程创建和管理。
在创建场景进程的时候注册好回调函数。实现回调函数的模块就是玩法逻辑模块。

* 管理进程：负责副本逻辑，保存副本数据，接受场景回调，并向场景发送控制消息，如广播进度、消息等
* 场景进程：AOI，战斗、触发事件时通过回调函数通知管理进程

场景进程的回调主要包括：
* on_init 场景初始化
* on_enter 玩家进入场景，需要向玩家初始化副本数据，主要是副本面板需要展示的一些数据。
    - 倒计时
    - 已经获得经验、物品
    - 副本相关一些数据
* on_leave 玩家离开场景
* on_kill 击杀回调

这些回调函数主要是向管理进程发消息。天书前期实现的一些多人玩法主要是这种方式。
对于单人副本，这种方式设计过于冗余，对于多人副本，这种方式还可以接受。

## 单进程结构

通过在场景逻辑适当的地方添加回调函数，这些函数在特定的玩法模块中实现。
通过这种方式可以扩展场景进程的功能，用来处理一些多人副本的逻辑。
而且这部分代码不需要跟场景进程耦合在一起，便于维护。这种方式就是单进程结构。

单进程结构下，场景进程负责副本的逻辑，并保存副本的数据。
同样的，这种方式下场景进程也需要支持上面四种回调，只不过这种方式下，回调函数不是向管理进程发消息，
而是在场景进程中处理逻辑，包括保存玩法数据、设置定时器等等。

场景进程除了需要支持上面的回调函数以外，还需要支持一个可定制的事件回调on_event：
* on_event 副本逻辑事件，主要是一些定时器触发。
* on_init 初始化结束时间，用于实现倒计时通告，以及其他副本数据

天书后期实现的一些多人玩法主要是这种方式，而且对于单人副本，这种方式也是适用的。
因此，更推荐使用这种方式来实现副本。

## 其他Tips

### 倒计时

管理进程根据副本时间计算好副本的结束时间，并且设置好结束定时器，玩家进入场景的时候推送倒计时等信息。

### 活动结束
当活动触发结束条件时，活动准备结束，管理进程负责通知场景进程冻结场景，玩家不能继续战斗，怪物也不执行AI。
通知结算，设置清场定时器，等待玩家退出场景。

### 踢人

所谓踢人，就是将玩家强制切出副本场景。需要踢人的情况主要是三种：
* 副本结束
* 玩家超出时间
* 死亡次数超过上限

踢人是通过向玩家进程发消息来实现的。因为副本也包括了单服副本和跨服副本，跨服情况下如果场景进程没有保存玩家进程，
那么后面的一些逻辑处理起来就麻烦一些。因此最好就是在玩家进入场景的时候存下玩家进程和网关进程，
玩家进程用来实现踢人等功能，网关进程用来给客户端发消息。

### 经验和掉落物

玩家拾取掉落物，经验都是在玩家进程执行的，需要玩家进程通知副本场景进程。副本场景ID一般设置为大于1000的整数。
发现是副本场景，直接向场景进程cast消息即可。场景进程增加两个消息处理函数，并且直接在进程字典中记录玩家获得的经验和物品。
* {on_drop_item, PlayerId, Reward}
* {on_add_exp, PlayerId, Value}

### 玩家血量

副本中死亡，掉线重连，需要维持死亡状态。

所以副本里面还是需要保存一份玩家的数据。

弹了倒计时界面。但是还是复活了。
